ロックマン２スプライト処理ちょっとした修正パッチ
配布元ＨＰ：http://sldnoonmoon.hp.infoseek.co.jp/
　　　　　（Neoぼろくず工房）

●概要
　ロックマン２には、スプライト処理に２つほど小さな不具合があります。

　（１）スプライト数が上限に達すると、アニメーション速度が半減する
　（２）一部のオブジェクトが消える瞬間、
　　　　本来表示されっぱなしのはずのスプライトが一瞬、非表示になることがある

　それを修正してみようというパッチ。

●パッチ説明・使い方
　R2SpriteFix.ips
　のパッチを当てると、「概容」の（１）（２）が修正されます。たぶん。
　このパッチにおいて、プログラム追加を行っているため、
　プログラムが追加されている改造には正常に当たらないと思います。

　プログラム追加のある改造を作られている方で、
　もしこのパッチを使いたいと思われた方は、
　このファイルの後ろのソースを見ればどの辺を弄るか分かると思うので、
　ご自由にご利用ください。

●不具合・補足など
・基本的にロクにテストしていないのでバグるかもしれません。
・（１）についてあーだこーだ
　・画面内にオブジェクトが大量に存在し、
　　スプライト６４枚を使い果たすと、
　　一定のルールに基づき、スプライトが点滅し始めます。
　　それ自体は、スプライト数上限を擬似的に増やす、
　　オブジェクト同士が重なったときに交互に表示する、
　　といったことを目的としていると思われる、ロックマンシリーズの共通の処理です。
　・ロックマン２に限り、点滅を始めたオブジェクトの
　　アニメーションの速度が半減してしまうというバグ（仕様？）があります。
　　プレス数基があるシーンや、
　　メカドラゴン戦や、ブービーム戦で分かりやすいですが、
　　こうなると、ロックマンの歩き始めが鈍くなったり、
　　ノックバックの距離やスリップ距離が倍増したりと、
　　操作性が著しく悪化します。
　・スプライトを準備する処理において、
　　オブジェクトを順番に処理するわけですが、
　　あるオブジェクトにおいて、スプライトを使い果たすと、
　　それより後ろのオブジェクトは処理されなくなります。
　　また、スプライトを準備する処理において、アニメーションの処理も行っています。
　　よって、そこまでのオブジェクトによりスプライトを使い果たされ、
　　処理をスキップされたオブジェクト（＝点滅中のオブジェクト）の
　　アニメーション速度が半減してしまいます。
　　このパッチをにおいて、スプライトを使い果たした後も、
　　処理のスキップをしないようにコードを書きました。
　・本来スキップしている処理をスキップしないようにしたため、
　　僅かに処理の負荷が増加します。とはいえ、大差ないとは思いますが……
　　逆に、ロックマンの操作性が悪化しなくなったため、
　　処理落ちが軽減したようにすら感じるかもしれません。
・（２）についてあーだこーだ
　・ロックマンの使うクラッシュボムの爆発が消える瞬間や
　　最終ステージの汚水ポットンが消える瞬間に、
　　ロックマンや、その他のオブジェクト、
　　更にはゲージまでもが、１フレーム非表示になることがあります。
　・この現象は、アニメーションにより
　　自動的に削除されるように設計されたオブジェクトにおいて起きます。
　　自動的に削除される際、
　　戻り値となるキャリーフラグの値をセットしていない不具合のようです。
　　そのため、それより後方のオブジェクトの処理をスキップしてしまうようです。
　・問題を解決するため
　　キャリーフラグをクリアしてからリターンするように修正しました。
　・ちなみに、クラッシュマンの使うクラッシュボムは
　　別件で激しくちらつくため、このパッチでは（あまり？）変化がありません。

・（１）は結構知られていると思いますが、
　（２）は知らない方が多いのではないでしょうか。
　まぁ、それだけ、問題にならない、小さな問題という事ですが……
・スプライト処理でもObj[00-0F]とObj[10-1F]で処理を分けていることを知った。
　この辺の分け方もロックマン２の処理が軽い秘密なのだろうか……


　もしバグったら、ウェブサイトのほうに
　報告していただけると対処できるかもしれません。

●ソース
	.inesprg $10 ;プログラムバンク数
	.ineschr $00 ;キャラクタバンク数
	.inesmir 1 ;

	.inesmap 1

	.bank 0
	.org $0000

	.incbin "rockman2.prg"

BANKORG_D .macro
	.bank (\1>>16)
	.org (\1&$FFFF)
	.endm

	BANKORG_D $1ECCB7
	jsr SETUP_GAUGE_SPRITE_INIT
	BANKORG_D $1ECCBD
	jsr SETUP_GAUGE_SPRITE_INIT
	BANKORG_D $1ECD4B
	jsr SETUP_GAUGE_SPRITE_INIT
	BANKORG_D $1ECD51
	jsr SETUP_GAUGE_SPRITE_INIT

	BANKORG_D $1ECE28
	jmp DELETE_OBJX_CLC_RTS

	BANKORG_D $1ECF3A
	jmp DELETE_OBJX_CLC_RTS
	
	BANKORG_D $1ECE70
	jmp CANCEL_SPRITE_SETUP
	
	BANKORG_D $1ECEE8
	beq $CEF2

	BANKORG_D $1FF2B0
DELETE_OBJX_CLC_RTS:
	lsr $0420,x
	clc
	rts

CANCEL_SPRITE_SETUP:
	;最後のスプライトのアトリビュート。
	;正常な状態ならF8は未使用時以外にはならない
	lda $02FE
	cmp #$F8
	bne .canceled
	lda $8400,y
	jmp $CE73
.canceled
	jmp $CEF2

SETUP_GAUGE_SPRITE_INIT:
	lda $02FE
	cmp #$F8
	beq .NormalProc
	lda <$06
	bne .NormalProc
	jmp $CFE0
.NormalProc
	jmp $CF5A

