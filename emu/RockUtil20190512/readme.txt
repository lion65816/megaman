====================================================================================================
FCロックマン便利Luaスクリプト version 20190512

・ウェブサイト
　　　　　http://borokobo.web.fc2.com/
　　　　　（Neoぼろくず工房）
　　　　　http://www.geocities.jp/borokobo/
　　　　　（Neoぼろくず工房別館）

====================================================================================================
●あいさつ
　FCロックマン便利LuaスクリプトをＤＬしていただき、ありがとうございます。

●免責
　使用は自己責任でお願い致します。

●概要
　FCのロックマン、nesのメガマンをプレイする際に便利かもしれない機能を実行する
　FCEUX向けのLuaスクリプトです。
　基本的には自分用なのですが、デバッグなどにも便利かもしれないので公開します。
　あまり標準ではない目的のために作られているため、首を傾げたくなるような機能もあります。

●注意点
　Luaスクリプトからは色々な機能を利用可能ですので、
　書き方によっては悪意のある処理を行うこともできるはずです。
　もちろん動作は、スクリプトとして書いてある通りですので、
　セキュリティ的に気になる方は、よく中身を確かめた後で実行してください。

●利用方法
Files
　フォルダ内に、
Rockman*.nes
Megaman*.nes (*=1,2,3,4,5,6)
　をあるだけ配置してください。
　FCEUXにおいて、対象のゲームを起動したあと、_RockUtil.luaを実行する(エミュ窓にドロップする)と、
　スクリプトのメニューが開き、そこから各種機能を利用できます。
　Luaを実行したままゲームを切り替えても正しく動作するはずです。
　実行時とゲーム切替時は、念の為、画面下部に表示される情報
　(ナンバリングとRockman/Megaman)が正しいかを確かめると良いです。

●機能説明
○Debugger
　デバッガを起動します。Quitボタンを押すと、メインのメニューに戻ることが出来ます。
　ナンバリングによって微妙に機能が異なりますが、以下のような機能を利用できます。

　・Collision
　　オブジェクトの判定サイズ(Hitbox)を可視化します。
　　2つのObj間の相対サイズだけが設定されている場合、
　　片方を一定サイズに決めつけて表示しているものもあります。

　・TCollision
　　地形との判定を行った点を可視化します。

　・Terrain
　　地形の判定を可視化します。

　・Clsn(done)
　　Collisionと似ていますが、実際に判定が行われた場合のみ表示されます。
　　フレームごとに輪番で判定が行われている場合や、1Objが複数の判定を行う場合等を視認出来ます。

　・DragRock
　　有効にした状態だと、マウスの右ドラッグでロックマンを移動できます。
　　移動中は原則無敵になります。

　・F-Wep
　　フル装備になります。

　・N-Wep
　　武器が無くなります。

　・Tiwn
　　自滅します。ナンバリングによってはやられた時の状態を再現し即座にシーンを移行します。

　・「0-0」「00」「CP:0」など
　　ステージやチェックポイントを移動します。

　・ObjHP1
　　オブジェクトのHPを1にします。ボス撃破時の挙動調査など。

　・FlushObj
　　オブジェクトを強制的に削除します。

　・ClrItmFlg
　　アイテム取得状態をクリアし、再び出現する状態にします。

　・ClrBRush
　　ボスラッシュのボスを全滅したことにします。

　・Prog****
　　ゲームの進行状態を****で示される状態に変更します。ボスセレで押せば大体どうにかなります。

　・SoundTest
　　サウンドテストモードへ移行します。操作方法は省略します。Escapeでデバッグメニューに戻ります。

　・Quit
　　デバッグメニューを終え、メインメニューに戻ります。

○DeathCounter
　有効化すると、やられた場所と回数を記録するようになる変な機能です。
　有効化した状態でマウスカーソルを画面の右上隅に持っていくと、統計情報が表示されます。
　また、同じく左上に持っていくと、やられたアイコンが出っぱなしになります。
　記録は、Files/DeathCounter_????????.lua(????????:CRC32)に保存され、
　また、メインメニューのDeathCounterボタンの右の>から記録を削除できます。

○AutoTimer
　有効化した状態でプレイすると、開始時(タイトル画面でスタート)、
　ステージクリア時(あるタイミング)、クリア時(ファンファーレ終了時)に
　タイムを記録するようになります。
　タイムは実時間とフレーム数から計算された値がそれぞれに求められます。
　マウスカーソルを左下の方に持っていくと、タイム一覧を見ることが出来ます。
　左下の微妙に横にずれた位置に合わせると、ゲーム時間と実時間をそれぞれ見ることが出来ます。
　この機能が有効な間、Files/timer.txtに現在タイムが出力され続けます。
　このテキストを外部のソフトで読ませることにより色々できます。
　また、メインメニューのAutoTimerボタンの右の>から、状態の保存(Save)と復元(Load)が可能です。
　データは、Files/AutoTimer_????????.luaに保存されます。(????????:CRC32)

○MuteMusic
　有効化すると、音楽が鳴らなくなります。効果音は鳴ります。
　この機能はnesのメモリなどに極力干渉しないようになっています。
　つまり、処理落ちなどは音楽がなっている時と同様に起こり、
　また、無効化すると、鳴り続けていた場合と同様の再生位置から音がなり始めます。
　この性質により、エミュのムービーファイルがずれません……たぶん。
　メインメニューのMuteMusicボタンの右の>から、外部音楽プレイヤーとの連動機能を利用できます。
　消音にする代わりに、別の曲を鳴らすことができます。
　詳細は、「MuteMusicのExt.Player(外部プレイヤー)機能について」をご参照ください。

○Achievement
　実績のような機能を追加します。
　詳細は、「Achievementについて」をご参照ください。

○FastPlaying
　有効化すると、カットシーン等、ゲームの無操作時間を早送りで飛ばすようになります。
　風情はなくなりますが、テキパキとプレイすることが可能になります。

○LagSkip
　有効化すると、ラグが発生したフレームを早送りで飛ばすようになります。
　これにより、見かけ上ゲームの実行速度が落ちずにプレイできます。
　細かく早送りされることにより、音がひどいことになり、
　また、どこか微妙に操作感や見かけが変化するため、実用性は皆無です。

○Set as default
　有効・無効を切り替えて使う機能の状態を記録します。
　スクリプトを再起動した場合やゲームを切り替えた場合に、
　この記録に応じて、各種機能の有効・無効を設定します。

●MuteMusicのExt.Player(外部プレイヤー)機能について
　音楽をミュートにする代わりに、その音楽の番号に対応した曲を、
　外部音楽プレイヤーアプリケーションで鳴らすという、誰も使わんだろそれ、という機能です。
　MuteMusicを有効にした後、
　メインメニューのMuteMusicボタンの右の>を押すと、Ext.Playerボタンが出現します。
　このボタンを押すと、初回（定義ファイルを作る前）は、ボタンがCheck Dfn.と変化します。
　また、Lua ScriptのConsoleにDefinition file : (定義ファイルのパス)と出力されます。
　そのパスのファイルを編集し、外部プレイヤーと、それに渡す引数を指定します。（後述）

　定義ファイルが存在している状態で、MuteMusicを有効にした後、
　Ext.Playerボタンを押し、Enabledにすると、外部プレイヤー機能が有効になります。
　つまり、指定した音楽が、外部音楽プレイヤーアプリケーションで鳴ることになります。

○定義ファイルの編集について
　適当なテキストエディタで編集します。編集方法そのものについては説明しません。
　定義ファイルはそれ自体がLuaファイルであるので、あまり崩さないようにしてください。
　特に\を入れてしまうと直ちに問題になります。代わりに\\を使うとどうにかなることもあります。
　定義ファイルでは、MM.Dfnテーブルを定義します。以下、テーブルの要素を説明します。

　・CommandF
　　コマンドの前方の部分を指定します。
　　例：CommandF="start wmplayer.exe"

　・CommandB
　　コマンドの後方の部分を指定します。

　・Method
　　コマンドの実行方法を指定します。
　　0だと、Lua ScriptのConsoleに出力されるのみで、実際には実行されません。（デバッグ用）
　　1だと、Luaのio.popenコマンドで実行されます。
　　2だと、Files/ExternalPlayerCmd.txtに出力されます。

　　実際に使うならば、1を指定することになりますが、
　　コマンドを実行するたびにコマンドプロンプトの黒窓が一瞬表示され、
　　ウィンドウが非アクティブになり鬱陶しい事この上ないです。対処法？無いよ。

　・AudioFilePath
　　音楽データのあるディレクトリを指定する事もできます。
　　バラバラな位置のファイルを指定したい場合は空欄にしておきます。

　・[0x00]から[0xEF]
　　それぞれの音楽番号に対応する音楽ファイル名を指定します。
　　AudioFilePathを指定しない時はフルパスを与えます。

　・[0xF0]から[0xFF]
　　無音にしたい時のファイルを指定します。
　　無音の音楽ファイルを指定するとうまくいくかもしれません。

　・[0x100]から[0x1FF]
　　各音楽ファイルの、タイトル情報等を記載できます。
　　0x100引いたファイルの情報を指定することになります。
　　コマンドが実行されるたびに、Files/ExternalPlayerInfo.txtに
　　対応する曲の、この情報が書き込まれます。


　・結局の所、以下のコマンドが実行されます。

[CommandF] [AudioFilePath][0x00等] [CommandB]

　　上の例で上げたようにCommandF="start wmplayer.exe"として、
　　[0x00]等にファイル名を指定すれば、
　　一応、ウィンドウズメディアプレイヤーで起動はできると思います。
　　現実には、コマンドプロンプトの黒窓にアクティブが移るだけではなく、
　　ウィンドウズメディアプレイヤーブアクティブになってしまうため、
　　控えめに言っても、実用性はゼロで使い物になりません。
　　コマンドラインから起動でき、その際アクティブにならないようなプレイヤーが必要になります。
　　黒窓問題は更に対処が困難です。

●Achievementについて
○概要
　「実績」のような機能です。説明書きをすると長くなってしまいますが、
　とにかく有効にしてプレイしてみると色々獲得できて、ちょっと面白いかもしれません。
　一口に実績と言っても色々な項目があることが普通ですが、
　実質、改造ロックマン向けのスクリプトである事も考えて、実績の項目は次節のように決めました。

○実績の3要素
　本機能の実績は3つの要素があり、それらをすべてかけ合わせた数の実績を用意しました。
　数は多いですが、「通し」「ノーダメージ」「豆のみ」が
　同時に達成できれば全ての実績を獲得できます。できればね……

(1)計測区間
　・Play Through/ゲームを開始してからクリアするまで
　・Level/各ステージに入ってからボスが出現するまで(途中にボスが居るステージはそこを除く)
　・Boss/ボスが出現してから倒すまで
　・Level&Boss/各ステージに入ってからそのステージをクリアするまで

　LevelとLevel&Bossはステージの数だけ、Bossはボスの数だけ計測区間があります。
　Bossは「ボスが出現してから」とあるように、戦うたびに仕切り直しが出来ます。
　ノーダメージで倒せるまで、何度も同じボスと戦う、等が可能です。
　LevelとLevel&Bossはゲームオーバーになったステージにもう一度入ると、仕切り直されています。

(2)ライフに関する項目
　・*/条件なし
　・NoPause/セレクトによるポーズなし(1作目のみ)
　・NoCont/コンティニューなし(Play Throughのみ)
　・NoTank/缶類なし(1作目には無し)
　・NoMiss/やられない(Bossには無し)
　・NoDmg/ダメージを受けない

(3)武器に関する項目
　・*/条件なし
　・b/ロックバスターのみ
　・m/豆(ロックバスターのチャージ無し)のみ(チャージのあるナンバリングのみ)

○実績の獲得
　この機能を有効にしてプレイし、条件を満たすと、以下のようなテキストがポップされます。

Achievement:Level(ステージ名)(4+0)
   * & No Tanks
   * & Buster Only

　とても分かりづらいのですが、計測区間はLevel、つまりステージクリア実績を得たという情報です。
　(4+0)というのは新規に4個の実績をまとめて獲得したということです。
　+0の部分は、既に獲得していた実績を再獲得ということです。(この場合はなし)
　なお、既に獲得していた実績のみを獲得した時はポップアップは表示されません。
　中段は「(2)ライフに関する項目」に対するもので、この場合は2つの条件を満たしています。
　下段は「(3)武器に関する項目」に対するもので、この場合は2つの条件を満たしています。
　2×2で4個の実績を獲得したわけです。
「条件無し」が一つの条件として扱われているのはどうかとも思いますが。

○実績一覧の見方
　前節の様に獲得した実績は、メインのメニューのAchievementボタンの右の>を押すと表示される、
　Viewボタンを押下することで、実績リストを表示/非表示することができます。
　縦に収まりきらない分は、マウスポインタを上下に移動することでスクロールして表示されます。
　xが未獲得の実績、Oが獲得済みの実績を表します。
　Oにマウスポインタを乗せることで、実績の獲得回数や獲得日時等を表示可能です。
　また、今回のセッションで獲得した実績は、背景が緑色で表示されます。
　さらに、その実績が初回獲得であった場合は、橙色のOで表示されます。

○セッションの保存と復元
　実績のセーブは自動で行われるため、明示的にセーブロードの必要はありません。
　しかし、メインのメニューのAchievementボタンの右の>を押すと表示される、
　SaveとLoadボタンを押すことで、現在プレイ中のゲームの実績進行段階保存できます。
　これは、難しいゲームを、長時間(何日間も)かけてプレイするときの機能です。
　Save Stateと、このセッションのSaveを組み合わせる事で、ゲームを中断できます。
　Load Stateした後、セッションをLoadすれば、本機能を有効にした状態で続きからプレイできます。
　……言うまでもありませんが、この機能を利用することで、いくらでもやり直すことができます。
　あくまでも自己満足ですのでね？

○実績要素(3)の武器に関する項目の補足
　何がセーフで何がアウトなのか。危ないそうな事は、やらないに越したことはないです。
　メインのメニューのDbgボタンを押下することで、デバッグ情報のOn/Offを切り替えることが可能です。
　少々見づらいですが、現在の「実績獲得権」を確認できます。

・セーフ
　・バスター以外の武器や移動武器の射出
　・バスター以外の武器が弾かれる(「キンッ♪」)
　・バスターが(ダメージ値的に)無効の敵に他の武器を敵に当てる(重要)
　・豆の見かけのものを敵に当てる(3に例外あり)

・アウト
　・バスター以外の武器が敵に辺りHPが減る
　・バリア系等の武器で敵弾を消す
　・足止めなど特別な効果を持つ武器の効力を発揮する

・シリーズ別
　・(1)
　　・バスターで0ダメージの相手に他の武器を利用する事はセーフ(ガビョール等)
　　　受け止められているがセーフ

　・(2)
　　・タイムストッパーを発動させる事はアウト

　・(3)
　　・スパークショックで敵の動きを止める事はアウト
　　・ラッシュバスターバグで他の武器の攻撃力を利用する事はアウト

　・(4)
　　・ワイヤーで天井に到達した後のバスターを当てる事はセーフ
　　　ワイヤーのフックそのものはアウト
　　・フラッシュストッパーを使っても有効時間中に有効な敵が現れなければセーフ

　・(5)
　　・水上バイクの弾の利用はセーフ
　　・スーパーアローを敵に当てる事はアウト(当たらなければ問題なし)
　　・ビートを呼んだ後に撃てる豆を的に当てる事はセーフ

　・(6)
　　・ジェットロックマンのバスターを当てる事はセーフ
　　・パワーロックマンのチャージやフレイムブラストで特定の壁を破壊する事はセーフ
　　・プッカーをチャージショットでひっくり返す事はセーフ
　　・「弾かれている」とかなり不自然でもセーフ
　　　・メットールやブラウンやサイバーガビョールを装甲の上からパワーロックマンで倒す
　　　・防御する敵が防御を外す1f前に特殊武器などでダメージを与えつつ弾かれる
　　・「受け止められる」とダメージが入っていなそうでもアウト
　　　・ブレインブレイクを怒らせる
　　　・サブマリンフリャーの衣を剥がす
　　　・モリャー等をパワーロックマンで吹き飛ばす
　　　・盾を持った敵をヤマトスピアやパワーロックマンのチャージで攻撃する

○Free Mode
　前節の通り、豆が無効なボス(ザコも)は別の武器の利用が許可されていますが、
　その他にも一部、どうしても、武器を使わなければならない場所があります。
　そのような場所を攻略する為に、セレクトボタンを4秒以上押し続けてから離すことで、
　4秒間の"Free Mode"を発動させることができます。
　この間は、何をしても実績の権利を失いません。
　どの武器を使っても、被弾しても、E缶を使ってすら。
　"Free Mode"の利用後は、再度利用するには、8秒間のクールタイムが必要です。
　また、計測区間中に"Free Mode"を利用した回数は、実績に記録されます。
　・原作で他の武器を使わざる絵を得ない場所
　　ロックマン2:ブービームトラップの前の部屋の狭い通路を塞いでいる敵への対応
　　ロックマン3:ドクロスパークマンステージの最初のハシゴにいる敵への対応

●Extension機能について
　File/Extension.luaというファイル名でLuaスクリプトを配置しておくと、
　RockUtilが起動した際に読み込まれます。
　そのLuaの中で、必要な設定を行うことで各種拡張機能を自作することができるという
　これも、誰が使うんだそれという機能です。一応説明。

　テーブルExtension内に、
Extension.HookInOpenMainUIFunction(x,y,x0,lh)
　という関数を定義することで、メニューのUIが表示された瞬間に呼び出されます。
　メニューにボタンなどのUIを追加する用途に使われる事が想定されています。

　同様に、
Extension.HookInInitFunction()
　という関数を定義することで、別ゲームが読み込まれ初期化される時に呼び出されます。

　また、RU.Hookテーブル内に関数を追加(キーは任意で構わない)しておくことで、
　毎フレームその関数が呼び出されます。

　しかし、変数の名前が変だ……少し考えたがまともな名前が思い浮かばなかった。

●不具合・補足など
・基本的にロクにテストしていないのでバグるかもしれません。
　不具合や提案などあれば報告して頂ければ対応できるかもしれません。

●更新履歴
◎Ver.20190512
　・Achievement/MM2のバグを修正、さらにLevel&Bossカテゴリを追加し、また、1,3,4,5作目に対応
　・AutoTimer/MM3のバグを修正

◎Ver.20190419
　・Achievement機能を2作目・6作目向けに追加

◎Ver.20190224
　・Debugger/MM5のチェックポイント移動が正常に動作しなかった問題を修正
　・AutoTimer/ゲームがリセットされても状態を初期化しないように変更
　・AutoTimer/状態の保存・復元機能を追加
　・AutoTimer/開始時・終了時・セグメント分割時にメッセージを表示するよう追加
　・AutoTimer/RM/MM5のステージクリア検出アドレスを変更(一部改造に対応する為)
　・AutoTimer/MM2の計測開始タイミングを修正
　・MuteMusic/外部アプリケーションとの連動機能を追加
　・Extension機能を追加
　・実行中Luaが他のLuaを呼び出す時、フルパスで指定するように修正
　・その他、軽微な修正

◎Ver.20190113
　初版

●ライセンス
CRC32を求めるため、wikipediaの以下のページのプログラムを利用しています。
ウィキペディアの執筆者，2018，「巡回冗長検査」『ウィキペディア日本語版』，（2018年9月17日取得，https://ja.wikipedia.org/w/index.php?title=%E5%B7%A1%E5%9B%9E%E5%86%97%E9%95%B7%E6%A4%9C%E6%9F%BB&oldid=69965495）． 


●ソース・利用条件など
　ソースは見てのとおりです。
　改変等は、自己責任で、ご自由にどうぞ。悪用はしないでください。
